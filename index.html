<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEO-BAGHDAD // COMMAND CENTER</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;800&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --n-gold: #ffcc00;
            --n-neon: #00f2ff;
            --n-bg: #e0f2f7;
            --n-glass: rgba(10, 20, 30, 0.9);
            --n-border: 1px solid rgba(0, 242, 255, 0.5);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #000;
            font-family: 'JetBrains Mono', monospace; color: #fff;
        }

        canvas { display: block; outline: none; }

        /* --- THE LEGENDARY BOOT SEQUENCE --- */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1.5s ease-out;
        }
        .boot-wrap {
            width: 80%; max-width: 900px; height: 500px;
            background: #050505; border: 1px solid #222;
            padding: 30px; position: relative; overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.1);
        }
        #boot-log { font-size: 13px; color: var(--n-neon); line-height: 1.6; height: 100%; overflow: hidden; }
        .progress-bar { width: 100%; height: 4px; background: #111; margin-top: 20px; position: relative; }
        #progress-fill { width: 0%; height: 100%; background: var(--n-neon); box-shadow: 0 0 15px var(--n-neon); transition: 0.1s; }

        /* --- NEO-BAGHDAD MASTER HUD --- */
        #hud { position: fixed; inset: 0; pointer-events: none; z-index: 1000; opacity: 0; transition: 2s; }
        
        .panel { 
            position: absolute; background: var(--n-glass); border: var(--n-border); 
            padding: 20px; backdrop-filter: blur(15px); pointer-events: auto;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
        }

        .header-box { top: 30px; left: 30px; width: 420px; }
        .n-title { font-family: 'Orbitron'; font-weight: 900; color: var(--n-gold); font-size: 24px; letter-spacing: 3px; border-bottom: 2px solid var(--n-gold); margin-bottom: 10px; }
        .stat-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px; color: #888; }
        .stat-row b { color: var(--n-neon); }

        .alt-panel { bottom: 30px; left: 30px; width: 300px; text-align: center; }
        .alt-val { font-family: 'Orbitron'; font-size: 52px; font-weight: 900; color: #fff; margin: 5px 0; text-shadow: 0 0 20px rgba(0, 242, 255, 0.5); }

        .control-panel { top: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; }
        .m-btn {
            background: rgba(0, 242, 255, 0.05); border: 1px solid var(--n-neon); color: var(--n-neon);
            padding: 15px 25px; font-size: 11px; font-weight: 800; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .m-btn:hover { background: var(--n-neon); color: #000; transform: scale(1.05); }

        .data-slate { 
            bottom: 30px; right: 30px; width: 480px; 
            transform: translateX(120%); transition: 0.7s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .data-slate.active { transform: translateX(0); }

        .scan-line { width: 100%; height: 2px; background: var(--n-gold); margin: 15px 0; opacity: 0.5; animation: scan 2s infinite ease-in-out; }
        @keyframes scan { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; transform: scaleX(1.1); } }
    </style>
</head>
<body>

    <div id="boot-screen">
        <div class="boot-wrap">
            <div id="boot-log"></div>
            <div class="progress-bar"><div id="progress-fill"></div></div>
        </div>
    </div>

    <div id="hud">
        <div class="panel header-box">
            <div class="n-title">NEO-BAGHDAD // V12</div>
            <div class="stat-row"><span>OPERATOR:</span><b>COMMANDER MATTEO</b></div>
            <div class="stat-row"><span>SYSTEM:</span><b>QUANTUM-ROUND CITY ENGINE</b></div>
            <div class="stat-row"><span>VISIBILITY:</span><b style="color: #00ff00;">MAXIMUM SOLAR</b></div>
            <div id="terminal-feed" style="margin-top: 15px; font-size: 10px; color: #555; height: 60px; overflow: hidden;"></div>
        </div>

        <div class="control-panel">
            <button class="m-btn" onclick="setView('reset')">Standard View</button>
            <button class="m-btn" onclick="setView('nexus')">House of Wisdom</button>
            <button class="m-btn" onclick="toggleWeather()" id="weather-btn">Mode: Clear Day</button>
            <button class="m-btn" onclick="triggerFlare()" style="border-color: var(--n-gold); color: var(--n-gold);">Solar Flare Pulse</button>
        </div>

        <div class="panel alt-panel">
            <div style="font-size: 10px; letter-spacing: 2px; color: #666;">TELEMETRY // ALTITUDE</div>
            <div class="alt-val" id="alt-txt">0000m</div>
            <div style="width: 100%; height: 2px; background: #222;"><div id="alt-bar" style="width: 0%; height: 100%; background: var(--n-neon);"></div></div>
        </div>

        <div id="info-slate" class="panel data-slate">
            <div class="n-title" id="node-id">SCANNING...</div>
            <div class="scan-line"></div>
            <div id="node-desc" style="font-size: 14px; line-height: 1.8; color: #ccc;">
                Touch architectural nodes to initiate structural deep-scan and citizen metrics.
            </div>
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <div style="flex:1; border: 1px solid #333; padding: 10px; font-size: 10px; text-align: center;">INTEGRITY: 100%</div>
                <div style="flex:1; border: 1px solid #333; padding: 10px; font-size: 10px; text-align: center;">TYPE: RESIDENTIAL</div>
            </div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        /* --------------------------------------------------------------------
            1. CORE INITIALIZATION & BOOT
            --------------------------------------------------------------------
        */
        let scene, camera, renderer, controls, raycaster, mouse;
        let cityMesh, droneMesh, droneData = [];
        let isGoldenHour = false;
        let flareActive = false;

        const BOOT_LOGS = [
            ">> NEO-BAGHDAD OS LOADED...",
            ">> RESTORING ARCHIVED CODE (300+ LINES)...",
            ">> BYPASSING SQUIDLY PROTOCOLS...",
            ">> AUTHENTICATING COMMANDER MATTEO...",
            ">> CLEARING ATMOSPHERIC INTERFERENCE...",
            ">> GENERATING 25,000 ARCHITECTURAL NODES...",
            ">> SYNCHRONIZING 8,000 DATA DRONES...",
            ">> CALIBRATING SOLAR HIGH-NOON LIGHTING...",
            ">> GRID STABILITY: OPTIMAL.",
            ">> WELCOME BACK, MATTEO."
        ];

        function runBoot() {
            const log = document.getElementById('boot-log');
            const bar = document.getElementById('progress-fill');
            let idx = 0;
            
            const interval = setInterval(() => {
                const line = document.createElement('div');
                line.textContent = BOOT_LOGS[idx];
                log.appendChild(line);
                idx++;
                bar.style.width = (idx / BOOT_LOGS.length * 100) + "%";
                
                if (idx >= BOOT_LOGS.length) {
                    clearInterval(interval);
                    setTimeout(initNeoBaghdad, 1000);
                }
            }, 180);
        }
        runBoot();

        /* --------------------------------------------------------------------
            2. THE 3D ENGINE
            --------------------------------------------------------------------
        */
        function initNeoBaghdad() {
            document.getElementById('boot-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('boot-screen').remove();
                document.getElementById('hud').style.opacity = '1';
            }, 1500);

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xd0e8f0); // Bright Day
            scene.fog = new THREE.FogExp2(0xd0e8f0, 0.00004);

            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 100, 150000);
            camera.position.set(15000, 10000, 15000);

            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI / 2.05;

            // Lights (The High-Visibility Sun)
            const sun = new THREE.DirectionalLight(0xffffff, 3);
            sun.position.set(5000, 15000, 5000);
            sun.name = "MainSun";
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0xbad7e9, 1.5));

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            buildCity();
            buildDrones();
            
            window.addEventListener('resize', onResize);
            window.addEventListener('mousedown', onInteract);
            window.addEventListener('mousemove', (e) => {
                mouse.x = (e.clientX/window.innerWidth)*2-1;
                mouse.y = -(e.clientY/window.innerHeight)*2+1;
            });

            animate();
            setInterval(pushFeed, 3000);
        }

        /* --------------------------------------------------------------------
            3. PROCEDURAL CONSTRUCTION (NEO-BAGHDAD)
            --------------------------------------------------------------------
        */
        function buildCity() {
            const count = 25000;
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshStandardMaterial({ 
                color: 0xffffff, 
                metalness: 0.6, 
                roughness: 0.2 
            });
            
            cityMesh = new THREE.InstancedMesh(geo, mat, count);
            const dummy = new THREE.Object3D();
            const color = new THREE.Color();

            for(let i=0; i<count; i++) {
                // Round City Logic (Concentric Rings)
                const angle = Math.random() * Math.PI * 2;
                const ring = Math.floor(Math.random() * 8) + 1;
                const r = ring * 3500 + (Math.random() * 1200);

                // Avoid placing in the main radial roads
                if (Math.abs(angle % (Math.PI / 4)) < 0.05) continue;

                const h = 200 + (Math.random() * 4500 * (1 / (ring * 0.5)));
                const w = 100 + Math.random() * 150;

                dummy.position.set(Math.cos(angle)*r, h/2, Math.sin(angle)*r);
                dummy.scale.set(w, h, w);
                dummy.updateMatrix();
                cityMesh.setMatrixAt(i, dummy.matrix);

                // Color coding based on height/function
                if (h > 3500) color.setHex(0x1a1a1a); // Obsidian Spire
                else if (h < 500) color.setHex(0xffffff); // Foundation Block
                else color.setHex(0xcccccc);
                cityMesh.setColorAt(i, color);
            }
            scene.add(cityMesh);

            // Ground Grid
            const grid = new THREE.GridHelper(120000, 100, 0x00f2ff, 0xbbbbbb);
            grid.material.opacity = 0.1;
            grid.material.transparent = true;
            scene.add(grid);

            // The House of Wisdom (Central Hub)
            const hubGeo = new THREE.CylinderGeometry(400, 600, 8000, 8);
            const hubMat = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 1 });
            const hub = new THREE.Mesh(hubGeo, hubMat);
            hub.position.y = 4000;
            hub.userData = { t: "THE HOUSE OF WISDOM", d: "Central AI processor and historical archive of Neo-Baghdad. Managing 12.4 Billion data packets per second." };
            scene.add(hub);
        }

        function buildDrones() {
            const count = 8000;
            const geo = new THREE.BoxGeometry(30, 8, 30);
            const mat = new THREE.MeshBasicMaterial({ color: 0x00f2ff });
            droneMesh = new THREE.InstancedMesh(geo, mat, count);
            
            const dummy = new THREE.Object3D();
            for(let i=0; i<count; i++) {
                const r = 4000 + Math.random() * 30000;
                const alt = 500 + Math.random() * 4000;
                const speed = 0.002 + Math.random() * 0.005;
                const angle = Math.random() * Math.PI * 2;

                droneData.push({ r, alt, speed, angle });
                dummy.position.set(Math.cos(angle)*r, alt, Math.sin(angle)*r);
                dummy.updateMatrix();
                droneMesh.setMatrixAt(i, dummy.matrix);
            }
            scene.add(droneMesh);
        }

        /* --------------------------------------------------------------------
            4. ANIMATION & COMMANDS
            --------------------------------------------------------------------
        */
        function animate() {
            requestAnimationFrame(animate);
            
            // Animate Drones
            const dummy = new THREE.Object3D();
            for(let i=0; i<droneData.length; i++) {
                const d = droneData[i];
                d.angle += d.speed;
                dummy.position.set(Math.cos(d.angle)*d.r, d.alt, Math.sin(d.angle)*d.r);
                dummy.rotation.y = -d.angle;
                dummy.updateMatrix();
                droneMesh.setMatrixAt(i, dummy.matrix);
            }
            droneMesh.instanceMatrix.needsUpdate = true;

            // Update Alt UI
            const alt = Math.round(camera.position.y);
            document.getElementById('alt-txt').innerText = alt + "m";
            document.getElementById('alt-bar').style.width = Math.min(100, (alt/25000)*100) + "%";

            // Flare Effect
            if (flareActive) {
                renderer.toneMappingExposure = 2.5 + Math.sin(Date.now() * 0.02);
            }

            controls.update();
            renderer.render(scene, camera);
        }

        function onInteract() {
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(scene.children, true);
            const slate = document.getElementById('info-slate');

            if (hits.length > 0) {
                const obj = hits[0].object;
                if (obj.userData.t) {
                    document.getElementById('node-id').innerText = obj.userData.t;
                    document.getElementById('node-desc').innerText = obj.userData.d;
                    slate.classList.add('active');
                } else if (obj === cityMesh) {
                    const id = hits[0].instanceId;
                    document.getElementById('node-id').innerText = "SECTOR BLOCK #" + (id % 9999);
                    document.getElementById('node-desc').innerText = "Standard habitation unit optimized for solar-energy absorption and water recycling. Current Occupancy: 4,500.";
                    slate.classList.add('active');
                }
            } else {
                slate.classList.remove('active');
            }
        }

        function pushFeed() {
            const feed = document.getElementById('terminal-feed');
            const lines = [
                ">> SOLAR YIELD: 98.4%", ">> DRONE GRID: STABLE", ">> COMMANDER MATTEO: AUTH OK", 
                ">> SECTOR 4 PURGE COMPLETE", ">> ARCHIVE SYNCING...", ">> WINDS: 12KM/H"
            ];
            const div = document.createElement('div');
            div.innerText = lines[Math.floor(Math.random()*lines.length)];
            feed.prepend(div);
            if(feed.children.length > 4) feed.lastChild.remove();
        }

        // --- EXPOSED FUNCTIONS ---
        window.setView = (type) => {
            if (type === 'nexus') {
                camera.position.set(2000, 5000, 2000);
                controls.target.set(0, 4000, 0);
            } else {
                camera.position.set(15000, 10000, 15000);
                controls.target.set(0, 0, 0);
            }
        };

        window.toggleWeather = () => {
            isGoldenHour = !isGoldenHour;
            const btn = document.getElementById('weather-btn');
            if (isGoldenHour) {
                scene.background = new THREE.Color(0xff8822);
                scene.fog.color = new THREE.Color(0xff8822);
                btn.innerText = "Mode: Golden Hour";
            } else {
                scene.background = new THREE.Color(0xd0e8f0);
                scene.fog.color = new THREE.Color(0xd0e8f0);
                btn.innerText = "Mode: Clear Day";
            }
        };

        window.triggerFlare = () => {
            flareActive = true;
            setTimeout(() => { flareActive = false; renderer.toneMappingExposure = 1.0; }, 3000);
        };

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

    </script>
</body>
</html>
