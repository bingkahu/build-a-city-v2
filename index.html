<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATTEO-CORE // COMMAND CENTER</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;800&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --m-neon: #00f2ff;
            --m-gold: #ffaa00;
            --m-bg: #010203;
            --m-glass: rgba(2, 6, 10, 0.95);
            --m-border: 1px solid rgba(0, 242, 255, 0.3);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: var(--m-bg);
            font-family: 'JetBrains Mono', monospace; color: #fff;
        }

        canvas { display: block; outline: none; }

        /* --- THE MATTEO BOOT SEQUENCE --- */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .terminal-wrap {
            width: 80%; max-width: 800px; height: 400px;
            background: #050505; border: 1px solid #1a1a1a;
            padding: 25px; position: relative; overflow: hidden;
        }
        #boot-log { font-size: 12px; color: var(--m-neon); line-height: 1.5; height: 100%; }
        .m-loader { width: 100%; height: 2px; background: #111; margin-top: 15px; }
        #m-bar { width: 0%; height: 100%; background: var(--m-neon); box-shadow: 0 0 10px var(--m-neon); }

        /* --- MASTER HUD ARCHITECTURE --- */
        #hud { position: fixed; inset: 0; pointer-events: none; z-index: 1000; opacity: 0; transition: 2s; }
        
        .panel { 
            position: absolute; background: var(--m-glass); border: var(--m-border); 
            padding: 20px; backdrop-filter: blur(10px); pointer-events: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        /* Top Left: Commander Identity */
        .id-card { top: 30px; left: 30px; width: 360px; }
        .id-header { font-family: 'Orbitron'; font-weight: 900; color: var(--m-gold); font-size: 18px; margin-bottom: 10px; border-bottom: 1px solid #333; }
        .stat-line { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 6px; color: #999; }
        .stat-val { color: var(--m-neon); font-weight: 800; }

        /* Top Right: Global Status */
        .status-card { top: 30px; right: 30px; text-align: right; width: 280px; }

        /* Navigation Matrix (Bottom Left) */
        .nav-card { bottom: 30px; left: 30px; width: 400px; }
        .alt-readout { font-size: 40px; font-family: 'Orbitron'; font-weight: 900; color: #fff; margin: 10px 0; }

        /* The Data Slate (Bottom Right) - For building info */
        .slate { 
            bottom: 30px; right: 30px; width: 450px; 
            transform: translateX(120%); transition: 0.6s cubic-bezier(0.2, 1, 0.3, 1);
        }
        .slate.active { transform: translateX(0); }
        .scan-bar { width: 100%; height: 2px; background: var(--m-neon); margin: 15px 0; opacity: 0.5; animation: pulse 2s infinite; }

        /* Action Buttons */
        .controls { position: absolute; right: 30px; top: 220px; display: flex; flex-direction: column; gap: 15px; pointer-events: auto; }
        .m-btn {
            background: rgba(0, 242, 255, 0.05); border: 1px solid var(--m-neon); color: var(--m-neon);
            padding: 15px 25px; font-size: 11px; font-weight: 800; letter-spacing: 2px;
            cursor: pointer; transition: 0.3s; text-transform: uppercase;
        }
        .m-btn:hover { background: var(--m-neon); color: #000; box-shadow: 0 0 20px var(--m-neon); }

        /* Terminal Feed */
        #feed { height: 80px; overflow: hidden; font-size: 10px; color: #666; margin-top: 15px; border-top: 1px dashed #222; padding-top: 10px; }

        @keyframes pulse { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="boot-screen">
        <div style="font-family: 'Orbitron'; font-size: 28px; margin-bottom: 20px;">MATTEO-CORE INITIALIZATION</div>
        <div class="terminal-wrap">
            <div id="boot-log"></div>
        </div>
        <div class="m-loader" style="width: 80%; max-width: 800px;">
            <div id="m-bar"></div>
        </div>
    </div>

    <div id="hud">
        <div class="panel id-card">
            <div class="id-header">COMMANDER: MATTEO</div>
            <div class="stat-line"><span>ACCESS LEVEL:</span><span class="stat-val">SUPREME-ARCHITECT</span></div>
            <div class="stat-line"><span>SYNC STATUS:</span><span class="stat-val">CRYSTAL CLEAR</span></div>
            <div class="stat-line"><span>SECTOR:</span><span class="stat-val">NEO-BAGHDAD PRIME</span></div>
            <div id="feed"></div>
        </div>

        <div class="panel status-card">
            <div class="stat-line"><span>GRID STABILITY:</span><span class="stat-val">100.0%</span></div>
            <div class="stat-line"><span>CITIZEN COUNT:</span><span class="stat-val">24,501,902</span></div>
            <div class="stat-line"><span>ENERGY YIELD:</span><span class="stat-val">842.1 PW</span></div>
            <div class="stat-line"><span>TIME:</span><span class="stat-val" id="m-clock">00:00:00</span></div>
        </div>

        <div class="controls">
            <button class="m-btn" onclick="setView('reset')">Standard Recon</button>
            <button class="m-btn" onclick="setView('nexus')">Nexus Spire</button>
            <button class="m-btn" onclick="toggleTour()">Auto-Survey</button>
            <button class="m-btn" onclick="triggerOverdrive()" style="border-color: var(--m-gold); color: var(--m-gold);">Grid Overdrive</button>
        </div>

        <div class="panel nav-card">
            <div style="font-size: 10px; letter-spacing: 2px; color: #555;">VERTICAL POSITIONING SYSTEM</div>
            <div class="alt-readout" id="alt-txt">0000m</div>
            <div style="width: 100%; height: 3px; background: #111;"><div id="alt-fill" style="height: 100%; width: 50%; background: var(--m-neon);"></div></div>
        </div>

        <div id="m-slate" class="panel slate">
            <div class="id-header" id="slate-title">SCANNING ARCHITECTURE...</div>
            <div class="scan-bar"></div>
            <div id="slate-body" style="font-size: 13px; line-height: 1.7; color: #ccc;">
                Touch a structure to decrypt its architectural metadata and resource allocation.
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <div style="flex:1; border: 1px solid #333; padding: 10px; font-size: 10px;">ID: VERIFIED</div>
                <div style="flex:1; border: 1px solid #333; padding: 10px; font-size: 10px;">AUTH: MATTEO</div>
            </div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        /* --------------------------------------------------------------------
            1. SYSTEM CONSTANTS & LORE DATA
            --------------------------------------------------------------------
        */
        let scene, camera, renderer, controls, raycaster, mouse;
        let trafficMesh, cityGroups = [];
        let overdriveActive = false;
        
        const CITY_LORE = {
            spire: { t: "THE MATTEO NEXUS", d: "The sovereign central processor. It manages the entire city's data flow and atmosphere scrubbing. Height: 5,200m." },
            resident: { t: "HABITATION MONOLITH", d: "A vertical district optimized for 500,000 citizens. Equipped with integrated solar-refractive glass and hydro-recycling." },
            industrial: { t: "FUSION FOUNDRY", d: "A high-output energy plant utilizing cold-fusion technology to power the outer residential rings." },
            archive: { t: "KNOWLEDGE SILO", d: "A hardened storage facility housing the digital history of Neo-Baghdad. Protected by Level-10 encryption." }
        };

        /* --------------------------------------------------------------------
            2. THE BOOTLOADER SEQUENCE (MATTEO VERSION)
            --------------------------------------------------------------------
        */
        const logContainer = document.getElementById('boot-log');
        const bootMessages = [
            ">> MATTEO-CORE V10.4 BOOTING...",
            ">> CHECKING USER PRIVILEGES: COMMANDER MATTEO DETECTED.",
            ">> CLEARING OBSCURE GEOMETRY ARRAYS...",
            ">> REMOVING BUBBLE-SHIELD OVERLAYS...",
            ">> SYNCHRONIZING 25,000 ARCHITECTURAL UNITS...",
            ">> DEPLOYING TRAFFIC GRID [5,000 DRONES]...",
            ">> CALIBRATING NEON ATMOSPHERE...",
            ">> SECURING GRID INTEGRITY...",
            ">> READY. WELCOME TO YOUR CITY, MATTEO."
        ];

        let msgIdx = 0;
        function runBoot() {
            if (msgIdx < bootMessages.length) {
                const line = document.createElement('div');
                line.textContent = bootMessages[msgIdx];
                logContainer.appendChild(line);
                document.getElementById('m-bar').style.width = ((msgIdx + 1) / bootMessages.length * 100) + "%";
                msgIdx++;
                setTimeout(runBoot, 200 + Math.random() * 300);
            } else {
                setTimeout(startMatteoEngine, 800);
            }
        }
        runBoot();

        /* --------------------------------------------------------------------
            3. SCENE INITIALIZATION (NO BUBBLES)
            --------------------------------------------------------------------
        */
        function startMatteoEngine() {
            document.getElementById('boot-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('boot-screen').remove();
                document.getElementById('hud').style.opacity = '1';
                initThree();
            }, 1000);
        }

        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x010305);
            scene.fog = new THREE.FogExp2(0x010305, 0.00008);

            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 10, 150000);
            camera.position.set(10000, 6000, 10000);

            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2.02; // Horizon lock
            controls.minDistance = 100;
            controls.maxDistance = 80000;

            // Lights
            const sun = new THREE.DirectionalLight(0xffffff, 2.5);
            sun.position.set(5000, 10000, 5000);
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0x1a2a4a, 1.2));

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Construction
            buildGroundGrid();
            buildNexusCenter();
            buildResidentialDistricts();
            buildIndustrialSectors();
            buildTrafficGrid();

            window.addEventListener('resize', onResize);
            window.addEventListener('mousemove', (e) => { mouse.x = (e.clientX/window.innerWidth)*2-1; mouse.y = -(e.clientY/window.innerHeight)*2+1; });
            window.addEventListener('mousedown', onInteract);
            
            animate();
            setInterval(updateClock, 1000);
            setInterval(pushLog, 2500);
        }

        /* --------------------------------------------------------------------
            4. CLEAN PROCEDURAL CONSTRUCTION
            --------------------------------------------------------------------
        */
        function buildGroundGrid() {
            const grid = new THREE.GridHelper(100000, 100, 0x00f2ff, 0x05151a);
            grid.material.opacity = 0.15;
            grid.material.transparent = true;
            scene.add(grid);
        }

        function buildNexusCenter() {
            // The Main Spire (Matteo's Throne)
            const g = new THREE.Group();
            
            // Core Pillar
            const pillarGeo = new THREE.CylinderGeometry(80, 250, 5200, 8);
            const pillarMat = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.9, roughness: 0.1 });
            const pillar = new THREE.Mesh(pillarGeo, pillarMat);
            pillar.position.y = 2600;
            pillar.userData = CITY_LORE.spire;
            g.add(pillar);

            // Tech Fins
            for(let i=0; i<4; i++) {
                const finGeo = new THREE.BoxGeometry(20, 3000, 400);
                const fin = new THREE.Mesh(finGeo, pillarMat);
                fin.position.y = 2000;
                fin.rotation.y = (Math.PI / 2) * i;
                fin.position.x = Math.cos(fin.rotation.y) * 200;
                fin.position.z = Math.sin(fin.rotation.y) * 200;
                g.add(fin);
            }

            // Energy Crown (No massive bubble!)
            const crownGeo = new THREE.TorusGeometry(350, 10, 16, 100);
            const crownMat = new THREE.MeshBasicMaterial({ color: 0x00f2ff });
            const crown = new THREE.Mesh(crownGeo, crownMat);
            crown.rotation.x = Math.PI/2;
            crown.position.y = 4800;
            g.add(crown);

            scene.add(g);
        }

        function buildResidentialDistricts() {
            const count = 15000;
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 0.8, roughness: 0.2 });
            const mesh = new THREE.InstancedMesh(geo, mat, count);
            
            const dummy = new THREE.Object3D();
            const color = new THREE.Color();

            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = 3000 + Math.random() * 12000;
                
                // Keep the cross-roads clear
                if (Math.abs(angle % (Math.PI / 2)) < 0.05) continue;

                const h = 200 + Math.random() * 2500;
                const w = 60 + Math.random() * 100;

                dummy.position.set(Math.cos(angle) * r, h/2, Math.sin(angle) * r);
                dummy.scale.set(w, h, w);
                dummy.updateMatrix();
                mesh.setMatrixAt(i, dummy.matrix);

                // Occasional Neon building
                if (Math.random() > 0.95) color.setHex(0x00f2ff);
                else color.setHex(0x333333);
                mesh.setColorAt(i, color);
            }
            scene.add(mesh);
            cityGroups.push(mesh);
        }

        function buildIndustrialSectors() {
            const count = 3000;
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshStandardMaterial({ color: 0xffaa00, metalness: 0.5 });
            const mesh = new THREE.InstancedMesh(geo, mat, count);
            
            const dummy = new THREE.Object3D();

            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = 18000 + Math.random() * 5000;
                
                const h = 400 + Math.random() * 800;
                const w = 200 + Math.random() * 400;

                dummy.position.set(Math.cos(angle) * r, h/2, Math.sin(angle) * r);
                dummy.scale.set(w, h, w);
                dummy.rotation.y = angle;
                dummy.updateMatrix();
                mesh.setMatrixAt(i, dummy.matrix);
            }
            scene.add(mesh);
            cityGroups.push(mesh);
        }

        function buildTrafficGrid() {
            const count = 5000;
            const geo = new THREE.BoxGeometry(20, 6, 40);
            const mat = new THREE.MeshBasicMaterial({ color: 0x00f2ff });
            trafficMesh = new THREE.InstancedMesh(geo, mat, count);
            
            const data = [];
            const dummy = new THREE.Object3D();

            for(let i=0; i<count; i++) {
                const r = 2500 + Math.random() * 20000;
                const speed = 0.001 + Math.random() * 0.004;
                const angle = Math.random() * Math.PI * 2;
                const alt = 400 + Math.random() * 3000;

                data.push({ r, speed, angle, alt });
                dummy.position.set(Math.cos(angle)*r, alt, Math.sin(angle)*r);
                dummy.updateMatrix();
                trafficMesh.setMatrixAt(i, dummy.matrix);
            }
            trafficMesh.userData = data;
            scene.add(trafficMesh);
        }

        /* --------------------------------------------------------------------
            5. ANIMATION & ENGINE LOGIC
            --------------------------------------------------------------------
        */
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;

            // Animate Traffic
            const tData = trafficMesh.userData;
            const dummy = new THREE.Object3D();
            for(let i=0; i<tData.length; i++) {
                const d = tData[i];
                d.angle += overdriveActive ? d.speed * 5 : d.speed;
                dummy.position.set(Math.cos(d.angle)*d.r, d.alt, Math.sin(d.angle)*d.r);
                dummy.rotation.y = -d.angle;
                dummy.updateMatrix();
                trafficMesh.setMatrixAt(i, dummy.matrix);
            }
            trafficMesh.instanceMatrix.needsUpdate = true;

            // HUD Data
            const altitude = Math.round(camera.position.y);
            document.getElementById('alt-txt').innerText = altitude + "m";
            document.getElementById('alt-fill').style.width = Math.min(100, (altitude / 30000) * 100) + "%";

            // Post-Processing Overdrive
            if (overdriveActive) {
                renderer.toneMappingExposure = 1.5 + Math.sin(time * 20) * 0.2;
                scene.fog.density = 0.0002;
            } else {
                renderer.toneMappingExposure = 1.0;
                scene.fog.density = 0.00008;
            }

            controls.update();
            renderer.render(scene, camera);
        }

        /* --------------------------------------------------------------------
            6. INTERACTION & UTILITIES
            --------------------------------------------------------------------
        */
        function onInteract(e) {
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(scene.children, true);
            const slate = document.getElementById('m-slate');

            if (hits.length > 0) {
                const obj = hits[0].object;
                
                if (obj.userData.t) {
                    // Nexus Click
                    document.getElementById('slate-title').innerText = obj.userData.t;
                    document.getElementById('slate-body').innerText = obj.userData.d;
                    slate.classList.add('active');
                } else if (obj.isInstancedMesh && obj !== trafficMesh) {
                    // City Block Click
                    const id = hits[0].instanceId;
                    document.getElementById('slate-title').innerText = "BLOCK #" + (id + 5000);
                    document.getElementById('slate-body').innerText = CITY_LORE.resident.d;
                    slate.classList.add('active');
                }
            } else {
                slate.classList.remove('active');
            }
        }

        function pushLog() {
            const feed = document.getElementById('feed');
            const msgs = [
                ">> SECTOR 7: POWER FLOW NOMINAL", ">> DATA PACKET 902 RECEIVED",
                ">> COMMANDER MATTEO: AUTH CONFIRMED", ">> ATMOSPHERIC QUALITY: 99.4%",
                ">> DRONE GRID: OPTIMIZED", ">> ALERT: SOLAR WIND DEFLECTED"
            ];
            const div = document.createElement('div');
            div.innerText = msgs[Math.floor(Math.random() * msgs.length)];
            feed.prepend(div);
            if (feed.children.length > 5) feed.lastChild.remove();
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('m-clock').innerText = now.toTimeString().split(' ')[0];
        }

        // --- EXPOSED COMMANDS ---
        window.setView = (type) => {
            if (type === 'nexus') {
                camera.position.set(2000, 4500, 2000);
                controls.target.set(0, 4000, 0);
            } else {
                camera.position.set(12000, 8000, 12000);
                controls.target.set(0, 0, 0);
            }
        };

        window.toggleTour = () => { controls.autoRotate = !controls.autoRotate; };
        
        window.triggerOverdrive = () => {
            overdriveActive = true;
            setTimeout(() => { overdriveActive = false; }, 4000);
        };

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

    </script>
</body>
</html>
