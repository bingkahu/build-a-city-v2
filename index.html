<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neo-Baghdad: Golden Hour</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #ffaa00; 
            --sand: #1a1610; 
            --hud: rgba(255, 170, 0, 0.15);
            --text: #ffdd99;
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #050505; 
            font-family: 'Rajdhani', sans-serif; 
        }
        
        canvas { display: block; }

        /* --- UI OVERLAY --- */
        #ui-layer {
            position: fixed; inset: 0; pointer-events: none; z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 30px;
        }

        .header {
            border-bottom: 2px solid var(--gold);
            display: inline-block; padding-bottom: 10px;
            pointer-events: auto;
        }

        h1 { 
            margin: 0; color: var(--gold); font-family: 'Cinzel'; 
            font-size: 2.5rem; letter-spacing: 5px; text-transform: uppercase;
            text-shadow: 0 0 20px rgba(255,170,0,0.5);
        }
        
        .sub { color: var(--text); letter-spacing: 3px; font-size: 0.9rem; opacity: 0.8; }

        .controls {
            pointer-events: auto; display: flex; gap: 10px;
        }

        button {
            background: rgba(0,0,0,0.6); border: 1px solid var(--gold);
            color: var(--gold); padding: 10px 20px;
            font-family: 'Rajdhani'; font-weight: 700; letter-spacing: 2px;
            cursor: pointer; transition: 0.3s; text-transform: uppercase;
        }
        button:hover { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }

        /* --- SCANNER CARD --- */
        #scanner {
            position: absolute; bottom: 100px; right: 30px; width: 350px;
            background: rgba(10, 8, 5, 0.9); border-left: 4px solid var(--gold);
            padding: 20px; transform: translateX(120%); transition: transform 0.4s ease;
            backdrop-filter: blur(8px); pointer-events: auto;
        }
        #scanner.active { transform: translateX(0); }
        
        #scan-type { color: var(--gold); font-size: 0.7rem; letter-spacing: 2px; margin-bottom: 5px; }
        #scan-title { font-size: 1.8rem; color: #fff; margin-bottom: 10px; font-family: 'Cinzel'; }
        #scan-desc { color: #aaa; line-height: 1.5; font-size: 0.95rem; }
        
        /* --- LOADING SCREEN --- */
        #loader {
            position: fixed; inset: 0; background: #000; z-index: 999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 1s;
        }
        .load-text { color: var(--gold); font-family: 'Cinzel'; letter-spacing: 10px; animation: pulse 2s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loader"><div class="load-text">ESTABLISHING UPLINK...</div></div>

    <div id="ui-layer">
        <div class="header">
            <h1>Neo-Baghdad</h1>
            <div class="sub">SECTOR: GOLDEN HOUR // STATUS: LIVE</div>
        </div>

        <div id="scanner">
            <div id="scan-type">SYSTEM SCAN</div>
            <div id="scan-title">--</div>
            <div id="scan-desc">--</div>
        </div>

        <div class="controls">
            <button onclick="resetCamera()">Reset View</button>
            <button onclick="toggleTour()">Auto-Tour</button>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js" } }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        // --- ENGINE CONFIG ---
        const CONFIG = {
            count: 12000,          // Lower count, higher quality
            radius: 12000,         // Smaller world for density
            sunColor: 0xffaa00,    // Golden hour
            skyColor: 0x110d0a     // Dark sunset
        };

        let scene, camera, renderer, controls;
        let cityMesh, shield, trafficRing, holograms;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let isTouring = false;
        let tourAngle = 0;

        init();

        function init() {
            // 1. SETUP
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.skyColor);
            scene.fog = new THREE.FogExp2(CONFIG.skyColor, 0.00015);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 10, 50000);
            camera.position.set(4000, 2500, 4000); // Closer start

            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI / 2.1;
            controls.minDistance = 200;
            controls.maxDistance = 15000;

            // 2. LIGHTING (Golden Hour)
            const sun = new THREE.DirectionalLight(CONFIG.sunColor, 3.5);
            sun.position.set(-5000, 2000, -5000); // Low angle
            sun.castShadow = true;
            sun.shadow.mapSize.set(2048, 2048);
            scene.add(sun);

            const hemi = new THREE.HemisphereLight(0x443355, 0x110d0a, 1.0); // Purple/Dark ground
            scene.add(hemi);

            // 3. BUILD WORLD
            createGround();
            createCentralPalace(); // "The House of Wisdom"
            createCity();
            createOrbitalTraffic();
            createHolograms();

            // 4. EVENTS
            window.addEventListener('resize', onResize);
            window.addEventListener('mousedown', onClick);
            
            // Remove loader
            setTimeout(() => document.getElementById('loader').style.opacity = 0, 800);
            setTimeout(() => document.getElementById('loader').remove(), 1800);

            animate();
        }

        function createGround() {
            // A dark, reflective grid floor
            const geo = new THREE.PlaneGeometry(60000, 60000);
            const mat = new THREE.MeshStandardMaterial({ 
                color: 0x080808, roughness: 0.1, metalness: 0.5 
            });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.rotation.x = -Math.PI / 2;
            mesh.receiveShadow = true;
            scene.add(mesh);

            const grid = new THREE.GridHelper(30000, 100, 0x332200, 0x111111);
            grid.position.y = 2;
            scene.add(grid);
        }

        function createCentralPalace() {
            // The massive central landmark
            const group = new THREE.Group();
            
            // Gold Material
            const goldMat = new THREE.MeshStandardMaterial({ color: 0xffaa00, roughness: 0.2, metalness: 1 });
            // Dark Tech Material
            const techMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.5 });

            // Base
            const base = new THREE.Mesh(new THREE.CylinderGeometry(600, 800, 400, 64), techMat);
            base.position.y = 200;
            
            // Spire
            const spire = new THREE.Mesh(new THREE.CylinderGeometry(20, 100, 3000, 8), goldMat);
            spire.position.y = 1500;

            // Energy Shield (Transparent Sphere)
            const shieldGeo = new THREE.SphereGeometry(1200, 64, 64, 0, Math.PI*2, 0, Math.PI/2);
            const shieldMat = new THREE.MeshPhysicalMaterial({
                color: 0x00aaff, transmission: 0.8, opacity: 0.3, transparent: true,
                roughness: 0, metalness: 0.1, ior: 1.4, side: THREE.DoubleSide
            });
            shield = new THREE.Mesh(shieldGeo, shieldMat);

            group.add(base, spire, shield);
            group.userData = { 
                type: "LANDMARK", 
                title: "THE SOLAR PALACE", 
                desc: "The administrative core. The blue energy shield filters 99% of UV radiation while allowing pure data transmission." 
            };
            scene.add(group);
        }

        function createCity() {
            // Dense, tall buildings
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshPhysicalMaterial({
                color: 0xffffff, metalness: 0.8, roughness: 0.1, reflectivity: 1
            });

            cityMesh = new THREE.InstancedMesh(geo, mat, CONFIG.count);
            
            const dummy = new THREE.Object3D();
            const color = new THREE.Color();

            for (let i = 0; i < CONFIG.count; i++) {
                // Better distribution: More dense in the middle
                const r = 900 + Math.pow(Math.random(), 0.8) * CONFIG.radius;
                const theta = Math.random() * Math.PI * 2;

                // Baghdad's "4 Gates" (Clear paths)
                if (Math.abs(theta % (Math.PI/2)) < 0.1) continue;

                // Height follows a curve (tall in center, small at edges)
                const distNorm = r / CONFIG.radius; // 0 to 1
                const h = 50 + Math.random() * 200 + (1 - distNorm) * 800;
                
                // Varied width
                const w = 30 + Math.random() * 50;

                dummy.position.set(Math.cos(theta)*r, h/2, Math.sin(theta)*r);
                dummy.scale.set(w, h, w);
                dummy.rotation.y = theta; // Face center
                dummy.updateMatrix();
                
                cityMesh.setMatrixAt(i, dummy.matrix);

                // Colors: Gold, Dark Grey, White
                if(Math.random() > 0.7) color.setHex(0xffaa00); // Gold
                else if(Math.random() > 0.9) color.setHex(0x00ccff); // Blue accent
                else color.setHex(0x333333); // Dark
                cityMesh.setColorAt(i, color);
            }
            scene.add(cityMesh);
        }

        function createOrbitalTraffic() {
            // Rings of moving ships
            const count = 1000;
            const geo = new THREE.BoxGeometry(10, 2, 5);
            const mat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
            trafficRing = new THREE.InstancedMesh(geo, mat, count);
            
            const dummy = new THREE.Object3D();
            const speeds = [];
            const rads = [];
            const angles = [];

            for(let i=0; i<count; i++){
                const r = 2000 + Math.random() * 8000;
                const y = 300 + Math.random() * 1000;
                rads.push({r, y});
                speeds.push((Math.random() + 0.5) * 0.002 * (Math.random()>0.5?1:-1));
                angles.push(Math.random() * Math.PI * 2);
            }
            
            trafficRing.userData = { speeds, rads, angles };
            scene.add(trafficRing);
        }

        function createHolograms() {
            // Floating billboards
            const count = 50;
            const geo = new THREE.PlaneGeometry(200, 100);
            const mat = new THREE.MeshBasicMaterial({ 
                color: 0x00ffff, side: THREE.DoubleSide, transparent: true, opacity: 0.4, blending: THREE.AdditiveBlending 
            });
            
            holograms = new THREE.InstancedMesh(geo, mat, count);
            const dummy = new THREE.Object3D();
            
            for(let i=0; i<count; i++){
                const r = 1500 + Math.random() * 4000;
                const theta = Math.random() * Math.PI * 2;
                dummy.position.set(Math.cos(theta)*r, 600 + Math.random()*800, Math.sin(theta)*r);
                dummy.lookAt(0, 600, 0);
                dummy.updateMatrix();
                holograms.setMatrixAt(i, dummy.matrix);
            }
            scene.add(holograms);
        }

        function animate() {
            requestAnimationFrame(animate);

            const time = Date.now() * 0.001;

            // Pulse Shield
            if(shield) {
                shield.scale.setScalar(1 + Math.sin(time)*0.01);
            }

            // Move Traffic
            const tData = trafficRing.userData;
            const dummy = new THREE.Object3D();
            for(let i=0; i<1000; i++) {
                tData.angles[i] += tData.speeds[i];
                const r = tData.rads[i].r;
                const y = tData.rads[i].y;
                const a = tData.angles[i];
                
                dummy.position.set(Math.cos(a)*r, y, Math.sin(a)*r);
                dummy.lookAt(Math.cos(a+0.1)*r, y, Math.sin(a+0.1)*r);
                dummy.updateMatrix();
                trafficRing.setMatrixAt(i, dummy.matrix);
            }
            trafficRing.instanceMatrix.needsUpdate = true;

            // Auto-Tour Camera
            if(isTouring) {
                tourAngle += 0.002;
                const dist = 3500;
                camera.position.x = Math.cos(tourAngle) * dist;
                camera.position.z = Math.sin(tourAngle) * dist;
                camera.lookAt(0, 500, 0);
            }

            controls.update();
            renderer.render(scene, camera);
        }

        // --- INTERACTION ---
        function onClick(e) {
            if(isTouring) return; // Disable clicks during tour
            
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            // Check Palace
            const hits = raycaster.intersectObjects(scene.children, true);
            let found = false;
            
            for(let hit of hits) {
                // Find parent group with data
                let obj = hit.object;
                while(obj.parent && !obj.userData.title) obj = obj.parent;
                
                if(obj.userData.title) {
                    showScan("LANDMARK DETECTED", obj.userData.title, obj.userData.desc);
                    found = true;
                    break;
                }
            }
            
            // Check City
            if(!found) {
                const cityHit = raycaster.intersectObject(cityMesh);
                if(cityHit.length > 0) {
                    const id = cityHit[0].instanceId;
                    showScan(
                        "SECTOR SCAN COMPLETE", 
                        `RESIDENCE BLOCK ${id}`, 
                        "Standard habitation unit. Solar efficiency: 98%. Current occupancy: 4,500."
                    );
                    found = true;
                }
            }

            if(!found) hideScan();
        }

        function showScan(type, title, desc) {
            const el = document.getElementById('scanner');
            document.getElementById('scan-type').innerText = type;
            document.getElementById('scan-title').innerText = title;
            document.getElementById('scan-desc').innerText = desc;
            el.classList.add('active');
        }
        function hideScan() {
            document.getElementById('scanner').classList.remove('active');
        }

        window.resetCamera = () => {
            isTouring = false;
            camera.position.set(4000, 2500, 4000);
            controls.target.set(0,0,0);
        };
        
        window.toggleTour = () => {
            isTouring = !isTouring;
        };

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
