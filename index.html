<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SQUIDLY-OS // MEGA-TITAN EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;800&family=Orbitron:wght@400;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon: #00ff9d; --gold: #ffcc00; --alert: #ff3300; --info: #00d4ff;
            --bg: #010406; --glass: rgba(0, 15, 20, 0.9);
            --border: 1px solid rgba(0, 255, 157, 0.3);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: var(--bg); color: #fff;
            font-family: 'JetBrains Mono', monospace;
        }

        canvas { display: block; outline: none; }

        /* --- THE BOOT SEQUENCE TERMINAL --- */
        #boot-overlay {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .boot-window {
            width: 90%; max-width: 800px; height: 500px;
            background: #050505; border: 1px solid #1a1a1a;
            padding: 30px; position: relative;
        }
        #boot-text { font-size: 13px; color: var(--neon); height: 100%; overflow: hidden; line-height: 1.6; }
        .progress-container { width: 100%; height: 2px; background: #111; margin-top: 20px; position: relative; }
        #progress-fill { width: 0%; height: 100%; background: var(--neon); box-shadow: 0 0 15px var(--neon); }

        /* --- THE MASTER HUD --- */
        #hud { position: fixed; inset: 0; pointer-events: none; z-index: 1000; opacity: 0; transition: 2s; }
        .panel { position: absolute; background: var(--glass); border: var(--border); padding: 15px; backdrop-filter: blur(15px); pointer-events: auto; }

        /* Top Left: Commander Access */
        .top-left { top: 20px; left: 20px; width: 350px; }
        .user-id { font-family: 'Orbitron'; font-weight: 900; color: var(--gold); font-size: 1.2rem; border-bottom: 1px solid #333; margin-bottom: 10px; }
        
        /* Top Right: Global Telemetry */
        .top-right { top: 20px; right: 20px; text-align: right; min-width: 200px; }
        .telemetry-row { display: flex; justify-content: space-between; gap: 20px; font-size: 12px; margin-bottom: 5px; color: #aaa; }
        .telemetry-val { color: var(--info); font-weight: 800; }

        /* Bottom Left: Navigation & Scale */
        .bottom-left { bottom: 20px; left: 20px; width: 400px; }
        .alt-display { font-size: 2rem; font-family: 'Orbitron'; font-weight: 700; color: #fff; }

        /* Bottom Right: Quantum Data Slate */
        .bottom-right { 
            bottom: 20px; right: 20px; width: 400px; 
            transform: translateX(120%); transition: 0.8s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        .bottom-right.active { transform: translateX(0); }

        /* Side Controls: Action Stack */
        .side-stack { position: absolute; right: 20px; top: 220px; display: flex; flex-direction: column; gap: 12px; pointer-events: auto; }
        .action-btn {
            background: rgba(0, 255, 157, 0.05); border: 1px solid var(--neon); color: var(--neon);
            padding: 12px 25px; cursor: pointer; font-size: 10px; font-weight: 800; letter-spacing: 2px;
            transition: 0.3s; text-transform: uppercase;
        }
        .action-btn:hover { background: var(--neon); color: #000; box-shadow: 0 0 20px var(--neon); }

        /* Floating Log: Scrolling Feed */
        #log-feed { 
            height: 100px; overflow: hidden; font-size: 10px; color: #555; 
            margin-top: 15px; border-top: 1px dotted #333; padding-top: 10px;
        }

        /* Animations */
        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .scanline { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, rgba(0, 255, 157, 0.1), transparent); height: 10%; animation: scanline 4s linear infinite; pointer-events: none; }
    </style>
</head>
<body>

    <div id="boot-overlay">
        <div style="font-family: 'Cinzel'; font-size: 30px; margin-bottom: 20px; color: #fff;">NEO-BAGHDAD</div>
        <div class="boot-window">
            <div id="boot-text"></div>
        </div>
        <div class="progress-container" style="width: 800px;"><div id="progress-fill"></div></div>
    </div>

    <div id="hud">
        <div class="panel top-left">
            <div class="user-id">ACCESS: COMMANDER MATTEO</div>
            <div class="telemetry-row"><span>NEURAL SYNC:</span><span class="telemetry-val">99.98%</span></div>
            <div class="telemetry-row"><span>GRID STATUS:</span><span class="telemetry-val" style="color: var(--neon);">OPTIMIZED</span></div>
            <div class="telemetry-row"><span>ENCRYPTION:</span><span class="telemetry-val">LEVEL TITAN</span></div>
            <div id="log-feed"></div>
        </div>

        <div class="panel top-right">
            <div class="telemetry-row"><span>LOCAL TIME:</span><span class="telemetry-val" id="hud-time">00:00:00</span></div>
            <div class="telemetry-row"><span>POPULATION:</span><span class="telemetry-val">18,421,092</span></div>
            <div class="telemetry-row"><span>ENERGY GAIN:</span><span class="telemetry-val">42.5 TW</span></div>
            <div class="telemetry-row"><span>AIR QUALITY:</span><span class="telemetry-val">88%</span></div>
        </div>

        <div class="side-stack">
            <button class="action-btn" onclick="camGoto('nexus')">Nexus Center</button>
            <button class="action-btn" onclick="camGoto('orbit')">Satellite Map</button>
            <button class="action-btn" onclick="toggleAutoRotate()">Auto-Survey</button>
            <button class="action-btn" onclick="triggerFlare()" style="border-color: var(--alert); color: var(--alert);">Solar Flare</button>
        </div>

        <div class="panel bottom-left">
            <div class="telemetry-row"><span style="font-size: 10px; letter-spacing: 3px;">TELEMETRY DATA // ALTITUDE</span></div>
            <div class="alt-display" id="alt-val">0000m</div>
            <div style="width: 100%; height: 4px; background: #111; margin-top: 10px;"><div id="alt-bar" style="height: 100%; width: 50%; background: var(--gold);"></div></div>
        </div>

        <div id="data-slate" class="panel bottom-right">
            <div class="scanline"></div>
            <div class="user-id" id="slate-title" style="font-size: 14px; color: var(--neon);">SCANNING SECTOR...</div>
            <p id="slate-body" style="font-size: 12px; line-height: 1.6; color: #ccc;">Select a structure to initialize quantum deep-scan.</p>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <div style="flex:1; border:1px solid #333; padding:5px; font-size:9px;">INTEGRITY: 100%</div>
                <div style="flex:1; border:1px solid #333; padding:5px; font-size:9px;">TYPE: ARCHITECTURAL</div>
            </div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        /* --------------------------------------------------------------------
            1. INITIAL CONFIGURATION & SYSTEM STATE
            --------------------------------------------------------------------
        */
        let scene, camera, renderer, controls, raycaster, mouse;
        let districts = [], trafficSystem, starField, cloudSystem;
        let flareMode = false, isAutoRotate = false;
        
        const LORE = [
            { t: "THE HOUSE OF WISDOM", d: "A 4.2km spire housing the Great Digital Library. It contains the collective knowledge of the vertical era." },
            { t: "RESIDENTIAL MONOLITH SEC-A", d: "High-density habitation node. Optimized for carbon-scrubbing and solar efficiency. Home to 200,000 citizens." },
            { t: "INDUSTRIAL CORE 09", d: "Deep-earth geothermal extractor and manufacturing plant. Powers the southern residential rings." },
            { t: "CRYSTAL BIO-GARDEN", d: "Self-sustaining ecosystem dome. Provides 15% of the city's oxygen and vertical agricultural yield." },
            { t: "NEURAL TRANSIT HUB", d: "Central node for the drone swarm network. Handles 50,000 traffic events per millisecond." }
        ];

        /* --------------------------------------------------------------------
            2. THE BOOTLOADER LOGIC
            --------------------------------------------------------------------
        */
        const bootBox = document.getElementById('boot-text');
        const bootLines = [
            "0x00: INITIALIZING SQUIDLY KERNEL...",
            "0x04: VERIFYING USER: MATTEO...",
            "0x09: USER ACCESS LEVEL: SOVEREIGN",
            "0x12: MAPPING CIRCULAR SECTOR ARRAYS...",
            "0x24: DEPLOYING 12,000 ARCHITECTURAL INSTANCES...",
            "0x38: SYNCHRONIZING TRAFFIC SWARM [2,000 UNITS]...",
            "0x42: ESTABLISHING QUANTUM HUD LINK...",
            "0x55: LOADING CRYSTAL BIOMES...",
            "0x70: CALIBRATING ATMOSPHERIC AETHER...",
            "0x88: BYPASSING ENCRYPTION GATES...",
            "0x99: SYSTEM LIVE. WELCOME, COMMANDER MATTEO."
        ];

        let lineIdx = 0;
        function runBoot() {
            if (lineIdx < bootLines.length) {
                const p = document.createElement('div');
                p.textContent = bootLines[lineIdx];
                bootBox.appendChild(p);
                document.getElementById('progress-fill').style.width = ((lineIdx+1) / bootLines.length * 100) + "%";
                lineIdx++;
                setTimeout(runBoot, 150 + Math.random() * 300);
            } else {
                setTimeout(initWorld, 1000);
            }
        }
        runBoot();

        /* --------------------------------------------------------------------
            3. SCENE INITIALIZATION
            --------------------------------------------------------------------
        */
        function initWorld() {
            document.getElementById('boot-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('boot-overlay').remove();
                document.getElementById('hud').style.opacity = '1';
                setupEngine();
            }, 1000);
        }

        function setupEngine() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020508);
            scene.fog = new THREE.FogExp2(0x020508, 0.00008);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 10, 200000);
            camera.position.set(10000, 6000, 10000);

            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI / 2.1;
            controls.minDistance = 200;
            controls.maxDistance = 60000;

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Lighting System
            const sun = new THREE.DirectionalLight(0xffffff, 3);
            sun.position.set(5000, 10000, 2000);
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0x1a2a4a, 1.5));

            buildMetropolis();
            createEnvironment();
            
            window.addEventListener('resize', onResize);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mousedown', onSelect);
            
            animate();
            setInterval(updateLogs, 2000);
            setInterval(() => {
                const now = new Date();
                document.getElementById('hud-time').innerText = now.toTimeString().split(' ')[0];
            }, 1000);
        }

        /* --------------------------------------------------------------------
            4. PROCEDURAL CONSTRUCTION
            --------------------------------------------------------------------
        */
        function buildMetropolis() {
            // 1. The Central Nexus (Complex Spire)
            const nexusGroup = new THREE.Group();
            const towerGeo = new THREE.CylinderGeometry(50, 300, 4200, 12);
            const towerMat = new THREE.MeshStandardMaterial({ color: 0xffcc00, metalness: 1, roughness: 0.1 });
            const spire = new THREE.Mesh(towerGeo, towerMat);
            spire.position.y = 2100;
            spire.userData = LORE[0];
            nexusGroup.add(spire);

            // Rotating Logic Rings
            for(let i=0; i<4; i++) {
                const ring = new THREE.Mesh(
                    new THREE.TorusGeometry(600 + i*200, 15, 16, 100),
                    new THREE.MeshBasicMaterial({ color: 0x00ff9d, transparent: true, opacity: 0.4 })
                );
                ring.rotation.x = Math.PI/2;
                ring.position.y = 1000 + i*800;
                nexusGroup.add(ring);
            }
            scene.add(nexusGroup);

            // 2. District Clusters (Using InstancedMesh for "Loads")
            // Residential
            createDistrict(2000, 7000, 10000, 0xcccccc, 1.0); 
            // Industrial
            createDistrict(8000, 12000, 4000, 0x884422, 0.4);
            // Bio-Domes
            createDistrict(13000, 15000, 500, 0x00d4ff, 0.1, true); 

            // 3. Traffic Swarm
            createTraffic(3000);
        }

        function createDistrict(inner, outer, count, colorHex, heightMult, isDome = false) {
            const geo = isDome ? new THREE.SphereGeometry(100, 16, 16) : new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshStandardMaterial({ color: colorHex, metalness: 0.7, roughness: 0.2 });
            const mesh = new THREE.InstancedMesh(geo, mat, count);
            
            const dummy = new THREE.Object3D();
            const color = new THREE.Color();

            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = inner + Math.random() * (outer - inner);
                
                // Clear the main cross-avenues
                if (Math.abs(angle % (Math.PI / 2)) < 0.08) continue;

                const h = (100 + Math.random() * 2000) * heightMult;
                const w = 40 + Math.random() * 80;

                dummy.position.set(Math.cos(angle)*r, isDome ? 50 : h/2, Math.sin(angle)*r);
                dummy.scale.set(w, h, w);
                dummy.rotation.y = angle;
                dummy.updateMatrix();
                mesh.setMatrixAt(i, dummy.matrix);

                if (Math.random() > 0.9) color.setHex(0x00ff9d);
                else color.setHex(colorHex);
                mesh.setColorAt(i, color);
            }
            scene.add(mesh);
            districts.push(mesh);
        }

        function createTraffic(count) {
            const geo = new THREE.BoxGeometry(15, 5, 40);
            const mat = new THREE.MeshBasicMaterial({ color: 0x00ff9d });
            trafficSystem = new THREE.InstancedMesh(geo, mat, count);
            
            const routes = [];
            const dummy = new THREE.Object3D();

            for (let i = 0; i < count; i++) {
                const r = 2500 + Math.random() * 15000;
                const angle = Math.random() * Math.PI * 2;
                const speed = 0.001 + Math.random() * 0.003;
                const altitude = 400 + Math.random() * 2000;
                
                routes.push({ r, angle, speed, altitude });
                dummy.position.set(Math.cos(angle)*r, altitude, Math.sin(angle)*r);
                dummy.updateMatrix();
                trafficSystem.setMatrixAt(i, dummy.matrix);
            }
            trafficSystem.userData = routes;
            scene.add(trafficSystem);
        }

        function createEnvironment() {
            // Starfield
            const starGeo = new THREE.BufferGeometry();
            const starPos = [];
            for(let i=0; i<15000; i++) {
                starPos.push((Math.random()-0.5)*100000, Math.random()*50000, (Math.random()-0.5)*100000);
            }
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
            starField = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 15 }));
            scene.add(starField);

            // Aether Particles (Floating Dust/Energy)
            const cloudGeo = new THREE.BufferGeometry();
            const cloudPos = [];
            for(let i=0; i<5000; i++) {
                cloudPos.push((Math.random()-0.5)*40000, Math.random()*5000, (Math.random()-0.5)*40000);
            }
            cloudGeo.setAttribute('position', new THREE.Float32BufferAttribute(cloudPos, 3));
            cloudSystem = new THREE.Points(cloudGeo, new THREE.PointsMaterial({ color: 0x00ff9d, size: 5, transparent: true, opacity: 0.2 }));
            scene.add(cloudSystem);
            
            // Ground Grid
            const grid = new THREE.GridHelper(60000, 100, 0x00ff9d, 0x05151a);
            grid.material.opacity = 0.15;
            grid.material.transparent = true;
            scene.add(grid);
        }

        /* --------------------------------------------------------------------
            5. ANIMATION & INTERACTION
            --------------------------------------------------------------------
        */
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;

            // Rotate Environment
            starField.rotation.y += 0.0001;
            cloudSystem.rotation.y -= 0.0002;

            // Animate Traffic
            const tData = trafficSystem.userData;
            const dummy = new THREE.Object3D();
            for (let i = 0; i < tData.length; i++) {
                const d = tData[i];
                d.angle += d.speed;
                dummy.position.set(Math.cos(d.angle)*d.r, d.altitude, Math.sin(d.angle)*d.r);
                dummy.rotation.y = -d.angle;
                dummy.updateMatrix();
                trafficSystem.setMatrixAt(i, dummy.matrix);
            }
            trafficSystem.instanceMatrix.needsUpdate = true;

            // Update Telemetry
            const alt = Math.round(camera.position.y);
            document.getElementById('alt-val').innerText = alt + "m";
            document.getElementById('alt-bar').style.width = Math.min(100, (alt/40000)*100) + "%";

            // Flare Effect
            if(flareMode) {
                scene.background.lerp(new THREE.Color(0xff2200), 0.1);
                renderer.toneMappingExposure = 2.5 + Math.sin(time*10);
            } else {
                scene.background.lerp(new THREE.Color(0x020508), 0.05);
                renderer.toneMappingExposure = 1.0;
            }

            controls.update();
            renderer.render(scene, camera);
        }

        function onSelect(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const slate = document.getElementById('data-slate');
            const hits = raycaster.intersectObjects(scene.children, true);
            
            if (hits.length > 0) {
                let obj = hits[0].object;
                if (obj.userData.t) {
                    document.getElementById('slate-title').innerText = obj.userData.t;
                    document.getElementById('slate-body').innerText = obj.userData.d;
                    slate.classList.add('active');
                } else if (obj.isInstancedMesh && obj !== trafficSystem) {
                    const id = hits[0].instanceId;
                    document.getElementById('slate-title').innerText = "UNIT ID: #" + (id + 1000);
                    document.getElementById('slate-body').innerText = LORE[1].d;
                    slate.classList.add('active');
                }
            } else {
                slate.classList.remove('active');
            }
        }

        function updateLogs() {
            const feed = document.getElementById('log-feed');
            const msgs = [
                ">> SECTOR 4: ENERGY SPIKE DETECTED", ">> DRONE #812: DOCKING COMPLETE",
                ">> ATMOSPHERIC PURGE: SUCCESSFUL", ">> ARCHIVE QUERY: MATTEO ACCESS GRANTED",
                ">> TRAFFIC FLOW: OPTIMAL", ">> WARNING: SOLAR WINDS INCREASING"
            ];
            const div = document.createElement('div');
            div.innerText = msgs[Math.floor(Math.random()*msgs.length)];
            feed.prepend(div);
            if(feed.children.length > 6) feed.lastChild.remove();
        }

        // --- GLOBAL RE-CON HOOKS ---
        window.camGoto = (loc) => {
            if(loc === 'nexus') {
                camera.position.set(3000, 3000, 3000);
                controls.target.set(0, 1500, 0);
            } else {
                camera.position.set(20000, 15000, 20000);
                controls.target.set(0, 0, 0);
            }
        };
        window.toggleAutoRotate = () => { controls.autoRotate = !controls.autoRotate; };
        window.triggerFlare = () => {
            flareMode = true;
            setTimeout(() => flareMode = false, 3500);
        };
        function onMouseMove(e) { mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1; }
        function onResize() { 
            camera.aspect = window.innerWidth / window.innerHeight; 
            camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
        }
    </script>
</body>
</html>
